# BandwidthLimiter

ç²¾ç¡®æ§åˆ¶æ¯ä½ç©å®¶çš„ç½‘ç»œå¸¦å®½ä¸Šé™ï¼Œä¿æŠ¤æœåŠ¡å™¨å…å—å¸¦å®½æ»¥ç”¨ï¼Œç¡®ä¿æ‰€æœ‰ç©å®¶çš„æµç•…ä½“éªŒã€‚

> åŸºäº Netty ChannelHandler å®ç°çš„çœŸå®å‡ºç«™æµé‡é™åˆ¶ Â· æ”¯æŒæ¯ç©å®¶ç‹¬ç«‹é…ç½® Â· Folia åŸç”Ÿå…¼å®¹

---

## âœ¨ æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| ğŸ”’ **æ¯ç©å®¶å¸¦å®½é™åˆ¶** | ä¸ºæ¯ä½ç©å®¶ç‹¬ç«‹è®¾ç½®å¸¦å®½ä¸Šé™ (KB/s)ï¼Œä½¿ç”¨ Netty çš„ `ChannelTrafficShapingHandler` å®ç°çœŸå®çš„å‡ºç«™æµé‡é™åˆ¶ |
| ğŸŒ¿ **Folia åŸç”Ÿå…¼å®¹** | ä½¿ç”¨ Folia çš„ `RegionScheduler` APIï¼Œå®Œç¾å…¼å®¹ Folia 1.21.1 çš„å¤šçº¿ç¨‹åŒºåŸŸåŒ–æ¶æ„ï¼ŒåŒæ—¶å‘ä¸‹å…¼å®¹ Paper/Spigot |
| âš¡ **å®æ—¶çƒ­æ›´æ–°** | ä¿®æ”¹é…ç½®æˆ–ä½¿ç”¨å‘½ä»¤åå³æ—¶ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯æœåŠ¡å™¨ã€‚æ”¯æŒè¿è¡Œæ—¶åŠ¨æ€è°ƒæ•´æ¯ä½ç©å®¶çš„å¸¦å®½é™åˆ¶ |
| ğŸ“Š **å¸¦å®½ç›‘æ§** | å®æ—¶æŸ¥çœ‹æ¯ä½ç©å®¶å½“å‰çš„å‡ºç«™å¸¦å®½ä½¿ç”¨æƒ…å†µï¼Œé€šè¿‡å‘½ä»¤éšæ—¶ç›‘æ§æœåŠ¡å™¨ç½‘ç»œçŠ¶æ€ |
| ğŸ›¡ï¸ **æƒé™ç³»ç»Ÿ** | å®Œå–„çš„æƒé™èŠ‚ç‚¹è®¾è®¡ï¼Œæ”¯æŒç»•è¿‡å¸¦å®½é™åˆ¶ã€ç®¡ç†å‘˜å‘½ä»¤ç­‰å¤šçº§æƒé™æ§åˆ¶ |
| ğŸ“ **çµæ´»é…ç½®** | YAML é…ç½®æ–‡ä»¶æ”¯æŒå…¨å±€é»˜è®¤å€¼å’Œæ¯ç©å®¶ç‹¬ç«‹é™åˆ¶ï¼Œæ”¯æŒé…ç½®çƒ­é‡è½½ |

---

## ğŸ”§ å·¥ä½œåŸç†

æ’ä»¶é€šè¿‡**åå°„**è·å–æ¯ä¸ªç©å®¶åº•å±‚çš„ Netty `Channel`ï¼Œç„¶ååœ¨ `ChannelPipeline` ä¸­æ³¨å…¥ Netty å†…ç½®çš„ `ChannelTrafficShapingHandler`ã€‚è¯¥ Handler é€šè¿‡å»¶è¿Ÿå†™æ“ä½œæ¥ç²¾ç¡®æ§åˆ¶**å‡ºç«™å¸¦å®½**ï¼ˆæœåŠ¡å™¨â†’å®¢æˆ·ç«¯ï¼‰ï¼Œå®ç°çœŸå®çš„å­—èŠ‚çº§æµé‡æ•´å½¢ï¼Œæ¯”åŸºäºæ•°æ®åŒ…è®¡æ•°çš„é™åˆ¶æ–¹æ¡ˆæ›´åŠ ç²¾ç¡®ã€‚

```
Player Connection Pipeline:
  ... â†’ Encoder â†’ [BandwidthLimiter Handler] â†’ ... â†’ Network
                       â†‘
            ChannelTrafficShapingHandler
            (é™åˆ¶å‡ºç«™å­—èŠ‚é€Ÿç‡)
```

---

## ğŸ“‹ å‘½ä»¤

æ‰€æœ‰å‘½ä»¤éœ€è¦ `bandwidthlimiter.admin` æƒé™ï¼ˆé»˜è®¤ OPï¼‰ã€‚

| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `/bwl set <ç©å®¶> <KB/s>` | ä¸ºæŒ‡å®šç©å®¶è®¾ç½®å¸¦å®½ä¸Šé™ |
| `/bwl remove <ç©å®¶>` | ç§»é™¤ç©å®¶çš„ç‹¬ç«‹é™åˆ¶ï¼Œæ¢å¤ä½¿ç”¨é»˜è®¤å€¼ |
| `/bwl info [ç©å®¶]` | æŸ¥çœ‹ç©å®¶çš„å¸¦å®½ä¿¡æ¯å’Œå®æ—¶ä½¿ç”¨çŠ¶æ€ |
| `/bwl default [KB/s]` | è®¾ç½®æˆ–æŸ¥çœ‹å…¨å±€é»˜è®¤å¸¦å®½é™åˆ¶ |
| `/bwl list` | åˆ—å‡ºæ‰€æœ‰åœ¨çº¿ç©å®¶çš„å¸¦å®½çŠ¶æ€ |
| `/bwl reload` | é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶ |

> **åˆ«å:** `/bwl`ã€`/bandwidth`ã€`/bandwidthlimiter`

---

## ğŸ›¡ï¸ æƒé™èŠ‚ç‚¹

| æƒé™èŠ‚ç‚¹ | è¯´æ˜ | é»˜è®¤ |
|----------|------|------|
| `bandwidthlimiter.admin` | ç®¡ç†å‘½ä»¤æƒé™ | OP |
| `bandwidthlimiter.bypass` | ç»•è¿‡å¸¦å®½é™åˆ¶ | æ—  |
| `bandwidthlimiter.info` | æŸ¥çœ‹è‡ªèº«å¸¦å®½ä¿¡æ¯ | æ‰€æœ‰äºº |

---

## ğŸ“ é…ç½®æ–‡ä»¶

æ’ä»¶é¦–æ¬¡å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨ç”Ÿæˆ `plugins/BandwidthLimiter/config.yml`ï¼š

```yaml
# é»˜è®¤å¸¦å®½é™åˆ¶ (KB/s)
# æ¨èå€¼:
#   256  - ä½å¸¦å®½æœåŠ¡å™¨
#   512  - æ ‡å‡†æœåŠ¡å™¨
#   1024 - é«˜æ€§èƒ½æœåŠ¡å™¨
#   2048 - å¤§å‹æœåŠ¡å™¨
default-limit-kbps: 512

# æ¯ä¸ªç©å®¶çš„ç‹¬ç«‹å¸¦å®½é™åˆ¶ (KB/s)
player-limits:
  # "069a79f4-44e9-4726-a5be-fca90e38aaf5": 1024
  # "PlayerName": 256
```

ä¿®æ”¹é…ç½®åä½¿ç”¨ `/bwl reload` å³å¯çƒ­æ›´æ–°ï¼Œæ— éœ€é‡å¯æœåŠ¡å™¨ã€‚

---

## ğŸ“¦ å®‰è£…æŒ‡å—

### ç¯å¢ƒè¦æ±‚

- **Java** 21 æˆ–æ›´é«˜ç‰ˆæœ¬
- **æœåŠ¡ç«¯** Folia 1.21.1 / Paper 1.21.1 / Spigot 1.21.1
- **æ— å‰ç½®æ’ä»¶**ä¾èµ–ï¼ˆä¸éœ€è¦ ProtocolLib ç­‰ï¼‰

### ä»æºç æ„å»º

```bash
git clone https://github.com/ColdTearsYY/BandwidthLimiter.git
cd BandwidthLimiter
mvn clean package
```

ç¼–è¯‘äº§ç‰©ä½äº `target/BandwidthLimiter-1.0.0.jar`ã€‚

### å®‰è£…åˆ°æœåŠ¡å™¨

1. å°† `BandwidthLimiter-1.0.0.jar` æ”¾å…¥æœåŠ¡å™¨çš„ `plugins/` ç›®å½•
2. å¯åŠ¨ï¼ˆæˆ–é‡å¯ï¼‰æœåŠ¡å™¨ï¼Œæ’ä»¶ä¼šè‡ªåŠ¨ç”Ÿæˆé»˜è®¤é…ç½®æ–‡ä»¶
3. æ ¹æ®éœ€è¦ä¿®æ”¹ `plugins/BandwidthLimiter/config.yml`ï¼Œä½¿ç”¨ `/bwl reload` çƒ­æ›´æ–°

---

## ğŸ—ï¸ é¡¹ç›®ç»“æ„

```
BandwidthLimiter/
â”œâ”€â”€ pom.xml                          # Maven æ„å»ºé…ç½®
â”œâ”€â”€ README.md
â””â”€â”€ src/main/
    â”œâ”€â”€ java/com/bandwidthlimiter/
    â”‚   â”œâ”€â”€ BandwidthLimiterPlugin.java   # æ’ä»¶ä¸»ç±»ï¼Œç”Ÿå‘½å‘¨æœŸç®¡ç†
    â”‚   â”œâ”€â”€ BandwidthManager.java         # å¸¦å®½ç®¡ç†å™¨ï¼Œåå°„æ³¨å…¥ Netty Handler
    â”‚   â”œâ”€â”€ PlayerBandwidthHandler.java   # åŸºäº ChannelTrafficShapingHandler çš„æµé‡æ•´å½¢
    â”‚   â”œâ”€â”€ BandwidthCommand.java         # å‘½ä»¤å¤„ç†å™¨ä¸ Tab è¡¥å…¨
    â”‚   â”œâ”€â”€ PlayerListener.java           # ç©å®¶åŠ å…¥/é€€å‡ºäº‹ä»¶ç›‘å¬
    â”‚   â””â”€â”€ FoliaUtil.java                # Folia/Paper/Spigot è°ƒåº¦å™¨å…¼å®¹å±‚
    â””â”€â”€ resources/
        â”œâ”€â”€ plugin.yml                    # Bukkit æ’ä»¶æè¿°æ–‡ä»¶
        â””â”€â”€ config.yml                    # é»˜è®¤é…ç½®æ–‡ä»¶
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

- å¸¦å®½é™åˆ¶ä¸å®œè®¾ç½®è¿‡ä½ï¼ˆå»ºè®®ä¸ä½äº **64 KB/s**ï¼‰ï¼Œå¦åˆ™ä¼šä¸¥é‡å½±å“ç©å®¶æ¸¸æˆä½“éªŒ
- æ’ä»¶ä½¿ç”¨åå°„è®¿é—® NMSï¼ˆ`net.minecraft.server`ï¼‰ï¼ŒæœåŠ¡ç«¯å¤§ç‰ˆæœ¬æ›´æ–°åå¯èƒ½éœ€è¦é€‚é…
- æ‹¥æœ‰ `bandwidthlimiter.bypass` æƒé™çš„ç©å®¶ä¸å—å¸¦å®½é™åˆ¶
- æ’ä»¶ä»…é™åˆ¶**å‡ºç«™å¸¦å®½**ï¼ˆæœåŠ¡å™¨â†’å®¢æˆ·ç«¯ï¼‰ï¼Œä¸é™åˆ¶å…¥ç«™æµé‡

---

## ğŸ“„ License

æœ¬é¡¹ç›®å¼€æºï¼Œæ¬¢è¿è´¡çŒ®ä»£ç å’Œæäº¤ Issueã€‚
